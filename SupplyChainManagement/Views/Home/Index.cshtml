@model SupplyChainManagement.Models.WarehouseDashboardViewModel
@using SupplyChainManagement.Models.Enums
@{
    ViewData["Title"] = "Home";
}

@if (User.IsInRole(SupplyChainManagement.Models.Enums.UserRoles.WarehouseStaff) && Model != null)
{
    <h1 class="mb-3">Warehouse Dashboard</h1>
    <div class="row g-3 mb-2">
        <div class="col-12 col-md-4">
            <a class="text-decoration-none text-white d-block" asp-controller="Shipments" asp-action="Index">
            <div class="card text-bg-info border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">Inbound Today</div>
                        <div class="small opacity-75">Shipments created today</div>
                    </div>
                    <div class="display-6 m-0">@Model.InboundTodayCount</div>
                </div>
            </div>
            </a>
        </div>
        <div class="col-12 col-md-4">
            <a class="text-decoration-none text-white d-block" asp-controller="Inventories" asp-action="Index" asp-route-low="true">
            <div class="card text-bg-danger border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">Low Stock</div>
                        <div class="small opacity-75">Items at/below reorder</div>
                    </div>
                    <div class="display-6 m-0">@Model.LowStockCount</div>
                </div>
            </div>
            </a>
        </div>
        <div class="col-12 col-md-4">
            <a class="text-decoration-none text-dark d-block" asp-controller="Orders" asp-action="Index" asp-route-status="due">
            <div class="card text-bg-warning border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-semibold">Outbound Due</div>
                        <div class="small opacity-75">Approved / unshipped orders</div>
                    </div>
                    <div class="display-6 m-0">@Model.OutboundDueCount</div>
                </div>
            </div>
            </a>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Inbound Shipments</span>
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Shipments" asp-action="Index">View All</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.InboundShipments == null || !Model.InboundShipments.Any())
                    {
                        <div class="p-3 text-muted">No inbound shipments.</div>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                        <li class="list-group-item placeholder-glow" id="inbound-skeleton">
                            <span class="placeholder col-3"></span>
                            <span class="placeholder col-2"></span>
                            <span class="placeholder col-1"></span>
                        </li>
                        @foreach (var s in Model.InboundShipments)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">Shipment #@s.Id <span class="badge bg-info ms-2">In Transit</span></div>
                                    <div class="small text-muted">Order #@s.OrderId • @s.CreatedAt.ToLocalTime()</div>
                                </div>
                                <span>
                                    <a class="btn btn-sm btn-outline-info" asp-controller="Shipments" asp-action="Details" asp-route-id="@s.Id">Details</a>
                                    @if (s.Status == ShipmentStatus.InTransit && (User.IsInRole(UserRoles.WarehouseStaff) || User.IsInRole(UserRoles.Supplier)))
                                    {
                                        <form asp-controller="Shipments" asp-action="MarkDelivered" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@s.Id" />
                                            <button type="submit" class="btn btn-sm btn-success ms-1">Mark Delivered</button>
                                        </form>
                                    }
                                </span>
                            </li>
                        }
                        </ul>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Low Stock</span>
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Inventories" asp-action="Index">View Inventory</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.LowStockInventories == null || !Model.LowStockInventories.Any())
                    {
                        <div class="p-3 text-muted">No low stock items.</div>
                    }
                    else
                    {
                        <table class="table mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">On Hand</th>
                                    <th class="text-end">Reorder</th>
                                    <th style="width: 180px;">Level</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var i in Model.LowStockInventories)
                            {
                                var percent = i.ReorderLevel > 0 ? Math.Clamp((int)Math.Round((double)i.QuantityOnHand / Math.Max(1, i.ReorderLevel) * 100), 0, 100) : 0;
                                var barClass = percent switch { <= 25 => "bg-danger", <= 60 => "bg-warning", _ => "bg-success" };
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px;">
                                                @{ var initials = (i.Product?.Name ?? "").Split(' ', StringSplitOptions.RemoveEmptyEntries).Take(2).Aggregate("", (acc, w) => acc + w[0]).ToUpper(); }
                                                <span class="small">@initials</span>
                                            </div>
                                            <span>@i.Product?.Name</span>
                                        </div>
                                    </td>
                                    <td class="text-end">@i.QuantityOnHand</td>
                                    <td class="text-end">@i.ReorderLevel</td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar @barClass" role="progressbar" style="width: @percent%" aria-valuenow="@percent" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Expiry & Quarantine Alerts</span>
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Inventories" asp-action="Index">View Inventory</a>
                </div>
                <div class="card-body p-0">
                    @if ((Model.ExpiringInventories == null || !Model.ExpiringInventories.Any()) && (Model.DamagedInventories == null || !Model.DamagedInventories.Any()))
                    {
                        <div class="p-3 text-muted">No alerts.</div>
                    }
                    else
                    {
                        <div class="row g-0">
                            <div class="col-12 col-md-6 border-end">
                                <div class="p-2 fw-semibold">Expiring (≤30 days)</div>
                                <ul class="list-group list-group-flush">
                                @foreach (var e in Model.ExpiringInventories)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@e.Product?.Name</span>
                                        <span class="badge bg-warning">@e.ExpiryDate?.ToString("yyyy-MM-dd")</span>
                                    </li>
                                }
                                </ul>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="p-2 fw-semibold">Damaged / Quarantine</div>
                                <ul class="list-group list-group-flush">
                                @foreach (var d in Model.DamagedInventories)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@d.Product?.Name</span>
                                        <span class="badge bg-danger">@d.DamagedQuantity</span>
                                    </li>
                                }
                                </ul>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Outbound Due Orders</span>
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Orders" asp-action="Index" asp-route-status="due">View Orders</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.OutboundDueOrders == null || !Model.OutboundDueOrders.Any())
                    {
                        <div class="p-3 text-muted">No outbound due orders.</div>
                    }
                    else
                    {
                        <table class="table mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th class="text-end">Lines</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var o in Model.OutboundDueOrders)
                            {
                                <tr>
                                    <td>@o.Id</td>
                                    <td>@o.CreatedAt.ToLocalTime()</td>
                                    <td><span class="badge bg-warning">@o.Status</span></td>
                                    <td class="text-end">@o.Items?.Count</td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-info" asp-controller="Orders" asp-action="Details" asp-route-id="@o.Id">Details</a>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>My Tasks <span class="badge bg-primary ms-2">@Model.MyOpenTasksCount</span></span>
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="WarehouseTasks" asp-action="My">View All</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.MyTasks == null || !Model.MyTasks.Any())
                    {
                        <div class="p-3 text-muted">No open tasks.</div>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                        @foreach (var t in Model.MyTasks)
                        {
                            var typeBadge = t.Type == SupplyChainManagement.Models.WarehouseTaskType.Putaway ? "info" : (t.Type == SupplyChainManagement.Models.WarehouseTaskType.Pick ? "warning" : "secondary");
                            var statusBadge = t.Status == SupplyChainManagement.Models.WarehouseTaskStatus.Open ? "secondary" : (t.Status == SupplyChainManagement.Models.WarehouseTaskStatus.InProgress ? "primary" : "success");
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">
                                        <span class="badge bg-@typeBadge me-2">@t.Type</span>
                                        @t.Product?.Name
                                    </div>
                                    <div class="small text-muted">Qty @t.Quantity @if(!string.IsNullOrEmpty(t.Bin)){<text>• Bin @t.Bin</text>} • Due @t.DueDate?.ToLocalTime().ToString("yyyy-MM-dd")</div>
                                </div>
                                <div>
                                    <span class="badge bg-@statusBadge me-2">@t.Status</span>
                                    @if (t.Status == SupplyChainManagement.Models.WarehouseTaskStatus.Open)
                                    {
                                        <form asp-controller="WarehouseTasks" asp-action="Start" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@t.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Start</button>
                                        </form>
                                    }
                                    else if (t.Status == SupplyChainManagement.Models.WarehouseTaskStatus.InProgress)
                                    {
                                        <form asp-controller="WarehouseTasks" asp-action="Complete" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@t.Id" />
                                            <button type="submit" class="btn btn-sm btn-success">Complete</button>
                                        </form>
                                    }
                                </div>
                            </li>
                        }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Recent Transactions</span>
                    <div class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-secondary" asp-controller="InventoryTransactions" asp-action="Index" asp-route-warehouseId="@Model.WarehouseId" asp-route-from="@DateTime.UtcNow.ToString("yyyy-MM-dd")">Today</a>
                        <a class="btn btn-sm btn-outline-secondary" asp-controller="InventoryTransactions" asp-action="Index" asp-route-warehouseId="@Model.WarehouseId" asp-route-from="@DateTime.UtcNow.AddDays(-7).ToString("yyyy-MM-dd")">Last 7 days</a>
                        <a class="btn btn-sm btn-outline-primary" asp-controller="InventoryTransactions" asp-action="Index" asp-route-warehouseId="@Model.WarehouseId">View All</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (Model.RecentTransactions == null || !Model.RecentTransactions.Any())
                    {
                        <div class="p-3 text-muted">No recent transactions.</div>
                    }
                    else
                    {
                        <table class="table mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>When</th>
                                    <th>Type</th>
                                    <th>Product</th>
                                    <th class="text-end">Qty</th>
                                    <th>Ref</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var t in Model.RecentTransactions)
                            {
                                var badge = t.Type switch
                                {
                                    InventoryTransactionType.Receipt => "success",
                                    InventoryTransactionType.Issue => "danger",
                                    InventoryTransactionType.Adjustment => "warning",
                                    InventoryTransactionType.TransferIn => "info",
                                    InventoryTransactionType.TransferOut => "secondary",
                                    _ => "secondary"
                                };
                                <tr>
                                    <td>@t.CreatedAt.ToLocalTime()</td>
                                    <td><span class="badge bg-@badge">@t.Type</span></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width:28px;height:28px;">
                                                @{ var initialsT = (t.Product?.Name ?? "").Split(' ', StringSplitOptions.RemoveEmptyEntries).Take(2).Aggregate("", (acc, w) => acc + w[0]).ToUpper(); }
                                                <span class="small">@initialsT</span>
                                            </div>
                                            <span>@t.Product?.Name</span>
                                        </div>
                                    </td>
                                    <td class="text-end">@t.Quantity</td>
                                    <td>@t.ReferenceType #@t.ReferenceId</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    <script>
        // Hide skeleton placeholders after a short delay to simulate loading shimmer
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const sk = document.getElementById('inbound-skeleton');
                if (sk) sk.classList.add('d-none');
            }, 200);
        });
    </script>
}
}
else
{
    <style>
        .landing-hero {
            background: linear-gradient(135deg, #0d6efd 0%, #20c997 100%);
            color: #fff;
            border-radius: 1rem;
            overflow: hidden;
        }
        .landing-hero .hero-img {
            background-image: url('https://images.unsplash.com/photo-1586521995568-39ec89b59241?q=80&w=1600&auto=format&fit=crop');
            background-size: cover; background-position: center;
            min-height: 220px;
        }
        .feature-icon { width: 46px; height: 46px; }
        .glass { background: rgba(255,255,255,.85); backdrop-filter: blur(6px); }
    </style>

    <div class="container-xxl">
        <div class="landing-hero shadow-sm mb-4">
            <div class="row g-0 align-items-center">
                <div class="col-12 col-lg-6 p-4 p-lg-5">
                    <h1 class="display-5 fw-bold mb-2">Supply Chain. Simplified.</h1>
                    <p class="lead mb-4">Track inventory, manage orders, and streamline shipments — all in one modern platform.</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <a class="btn btn-light btn-lg px-4" asp-area="Identity" asp-page="/Account/Login">Login</a>
                        <a class="btn btn-outline-light btn-lg px-4" asp-area="Identity" asp-page="/Account/Register">Get Started</a>
                    </div>
                </div>
                <div class="col-12 col-lg-6 hero-img"></div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
                <div class="card glass border-0 h-100">
                    <div class="card-body d-flex gap-3 align-items-start">
                        <div class="feature-icon rounded-circle bg-primary d-inline-flex align-items-center justify-content-center text-white">
                            <i class="bi bi-box-seam fs-4"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Inventory Intelligence</div>
                            <div class="small text-muted">Real-time stock insights with low-stock alerts and expiry tracking.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card glass border-0 h-100">
                    <div class="card-body d-flex gap-3 align-items-start">
                        <div class="feature-icon rounded-circle bg-success d-inline-flex align-items-center justify-content-center text-white">
                            <i class="bi bi-truck fs-4"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Fast Fulfillment</div>
                            <div class="small text-muted">Approve orders, create shipments and track delivery status with ease.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card glass border-0 h-100">
                    <div class="card-body d-flex gap-3 align-items-start">
                        <div class="feature-icon rounded-circle bg-warning d-inline-flex align-items-center justify-content-center text-white">
                            <i class="bi bi-graph-up-arrow fs-4"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Actionable Analytics</div>
                            <div class="small text-muted">See KPIs and trends to optimize operations and reduce stockouts.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client logos -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body py-4">
                <div class="text-center text-muted mb-3">Trusted by teams of all sizes</div>
                <div class="row text-center align-items-center g-3">
                    <div class="col-6 col-md-3">
                        <img src="https://dummyimage.com/180x50/ced4da/495057&text=ACME" class="img-fluid opacity-75" alt="Client 1" />
                    </div>
                    <div class="col-6 col-md-3">
                        <img src="https://dummyimage.com/180x50/ced4da/495057&text=Globex" class="img-fluid opacity-75" alt="Client 2" />
                    </div>
                    <div class="col-6 col-md-3">
                        <img src="https://dummyimage.com/180x50/ced4da/495057&text=Initech" class="img-fluid opacity-75" alt="Client 3" />
                    </div>
                    <div class="col-6 col-md-3">
                        <img src="https://dummyimage.com/180x50/ced4da/495057&text=Umbrella" class="img-fluid opacity-75" alt="Client 4" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Testimonials -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&auto=format&fit=crop" class="rounded-circle" alt="avatar" width="48" height="48" />
                            <div>
                                <div class="fw-semibold">Ayesha Rahman</div>
                                <div class="small text-muted">Operations Lead, ACME</div>
                            </div>
                        </div>
                        <p class="mb-0 text-muted">“Our team reduced stockouts by over 30% in the first quarter. The low-stock alerts are game-changing.”</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <img src="https://images.unsplash.com/photo-1554151228-14d9def656e4?q=80&w=200&auto=format&fit=crop" class="rounded-circle" alt="avatar" width="48" height="48" />
                            <div>
                                <div class="fw-semibold">Michael Chen</div>
                                <div class="small text-muted">Warehouse Manager, Globex</div>
                            </div>
                        </div>
                        <p class="mb-0 text-muted">“Picking is noticeably faster and error rates dropped. The UI is clean and easy for staff.”</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <img src="https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?q=80&w=200&auto=format&fit=crop" class="rounded-circle" alt="avatar" width="48" height="48" />
                            <div>
                                <div class="fw-semibold">Sara Ali</div>
                                <div class="small text-muted">Head of Supply, Initech</div>
                            </div>
                        </div>
                        <p class="mb-0 text-muted">“From purchase to delivery, everything is in one place. Exactly what our team needed.”</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 align-items-stretch">
            <div class="col-12 col-lg-7">
                <div class="card h-100 shadow-sm">
                    <img src="https://images.unsplash.com/photo-1543269865-cbf427effbad?q=80&w=1600&auto=format&fit=crop" class="card-img-top" alt="Analytics"/>
                    <div class="card-body">
                        <h5 class="card-title">Built for modern supply chains</h5>
                        <p class="card-text text-muted">From inbound receipts to outbound fulfillment, manage every step with intuitive workflows and robust controls.</p>
                        <a class="btn btn-primary" asp-area="Identity" asp-page="/Account/Register">Create your free account</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-5">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 py-3 border-end">
                                <div class="display-6 fw-bold">99.9%</div>
                                <div class="small text-muted">Uptime</div>
                            </div>
                            <div class="col-6 py-3">
                                <div class="display-6 fw-bold">5×</div>
                                <div class="small text-muted">Faster picking</div>
                            </div>
                            <div class="col-6 py-3 border-end border-top">
                                <div class="display-6 fw-bold">-35%</div>
                                <div class="small text-muted">Stockouts</div>
                            </div>
                            <div class="col-6 py-3 border-top">
                                <div class="display-6 fw-bold">24/7</div>
                                <div class="small text-muted">Support</div>
                            </div>
                        </div>
                        <hr />
                        <p class="text-muted">Join teams that trust our SCM to run resilient operations. Start by creating your account or sign in if you already have one.</p>
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-primary" asp-area="Identity" asp-page="/Account/Login">Sign in</a>
                            <a class="btn btn-primary" asp-area="Identity" asp-page="/Account/Register">Get started</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
